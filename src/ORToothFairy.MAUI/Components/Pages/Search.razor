@page "/"
@page "/search"

@using ORToothFairy.Core.Models

<div class="search-container">
    <h1>Find An Oregon Dental Hygienist</h1>

    <!-- Error Message Display -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">
            <p>⚠️ @errorMessage</p>
        </div>
    }

    <!-- Input Section -->
    <div class="search-inputs">
        <h2>How would you like to search?</h2>

        <!-- Option 1: Use My Location -->
        <div class="input-group">
            <button class="btn-primary" @onclick="UseMyLocation">
                📍 Use My Location
            </button>
        </div>

        <!-- Option 2: Zip Code -->
        <div class="input-group">
            <label>Or Enter Zip Code: </label>
            <input type="text"
                   @bind="zipCode"
                   placeholder="97124"
                   maxlength="5" />
            <button class="btn-secondary" @onclick="SearchByZip">
                Search by Zip
            </button>
        </div>

        <!-- Option 3: Address -->
        <div class="input-group">
            <label>Or Enter Address: </label>
            <input type="text"
                   @bind="address"
                   placeholder="123 Main St, Portland OR" />
            <button class="btn-secondary" @onclick="SearchByAddress">
                Search by Address
            </button>
        </div>
    </div>

    <!-- Distance Filter -->
    <div class="distance-filter">
        <label>Show practitioners within:</label>
        <select @bind="maxDistance" @bind:after="OnDistanceChanged">
            <option value="5">5 miles</option>
            <option value="10">10 miles</option>
            <option value="25" selected>25 miles</option>
            <option value="50">50 miles</option>
            <option value="999999">All</option>
        </select>
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Searching for practitioners...</p>
        </div>
    }

    <!-- Results List -->
    @if (!isLoading && results != null && results.Any())
    {
        <div class="results-list">
            <h2>@results.Count practitioners found</h2>

            @foreach (var practitioner in results)
            {
                <div class="practitioner-card">
                    <h3>@practitioner.FirstName @practitioner.LastName</h3>
                    <p class="distance">📍 @practitioner.UserPractitionerProximityMiles.ToString("F1") miles away</p>

                    <div class="contact-info">
                        @if (!string.IsNullOrEmpty(practitioner.Phone))
                        {
                            <a href="tel:@practitioner.Phone" class="contact-link">
                                📞 @practitioner.Phone
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(practitioner.Email))
                        {
                            <a href="mailto:@practitioner.Email" class="contact-link">
                                ✉️ @practitioner.Email
                            </a>
                        }
                    </div>

                    @if (practitioner.Services != null && practitioner.Services.Any())
                    {
                        <p class="services">Services: @string.Join(", ", practitioner.Services)</p>
                    }
                </div>
            }
        </div>
    }

    <!-- Empty State -->
    @if (!isLoading && hasSearched && (results == null || !results.Any()))
    {
        <div class="empty-state">
            @if (maxDistance < 999999)
            {
                <p>No practitioners found within @maxDistance miles.</p>
                <p>Try widening your search using the dropdown above.</p>
            }
            else
            {
                <p>No practitioners found.</p>
                <p>Please contact [Union Name] at [phone number] for assistance.</p>
            }
        </div>
    }
</div>

@code {
    private string lastZipCode = "";
    private string lastAddress = "";

    [Inject] private SearchService SearchService { get; set; } = default!;
    
    // State variables
    private string zipCode = "";
    private string address = "";
    private int maxDistance = 25;
    private bool isLoading = false;
    private bool hasSearched = false;
    private List<PractitionerSearchResult>? results;
    private List<PractitionerSearchResult>? allResults; // Cache for filtering
    private string? errorMessage;
    
    private async Task UseMyLocation()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged(); // Force UI update to show spinner
            
            // Request location permission
            var status = await Permissions.CheckStatusAsync<Permissions.LocationWhenInUse>();
            if (status != PermissionStatus.Granted)
            {
                status = await Permissions.RequestAsync<Permissions.LocationWhenInUse>();
            }
            
            if (status != PermissionStatus.Granted)
            {
                errorMessage = "Location permission denied. Please enable location access in your device settings.";
                return;
            }
            
            // Get current location
            var request = new GeolocationRequest(GeolocationAccuracy.Medium, TimeSpan.FromSeconds(10));
            var location = await Geolocation.GetLocationAsync(request);
            
            if (location == null)
            {
                errorMessage = "Unable to get your location. Please try again or use zip code/address.";
                return;
            }
            
            // Search using coordinates
            allResults = await SearchService.SearchByCoordinatesAsync(
                location.Latitude, 
                location.Longitude, 
                maxDistance);
            
            results = allResults;
            hasSearched = true;
        }
        catch (FeatureNotSupportedException)
        {
            errorMessage = "Geolocation is not supported on this device.";
        }
        catch (PermissionException)
        {
            errorMessage = "Location permission was denied.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error getting location: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged(); // Update UI with results or error
        }
    }
    
    private async Task SearchByZip()
    {
        if (string.IsNullOrWhiteSpace(zipCode) || zipCode.Length != 5)
        {
            errorMessage = "Please enter a valid 5-digit zip code.";
            return;
        }
        
        try
        {
            isLoading = true;
            errorMessage = null;
            hasSearched = true;
            lastZipCode = zipCode;
            lastAddress = ""; // Clear other
            StateHasChanged();
            
            allResults = await SearchService.SearchByZipCodeAsync(zipCode, maxDistance);
            results = allResults;
        }
        catch (Exception ex)
        {
            errorMessage = $"Search failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task SearchByAddress()
    {
        if (string.IsNullOrWhiteSpace(address))
        {
            errorMessage = "Please enter an address.";
            return;
        }
        
        try
        {
            isLoading = true;
            errorMessage = null;
            hasSearched = true;
            lastAddress = address;
            lastZipCode = ""; // Clear other
            StateHasChanged();
            
            allResults = await SearchService.SearchByAddressAsync(address, maxDistance);
            results = allResults;
        }
        catch (Exception ex)
        {
            errorMessage = $"Search failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void FilterResults()
    {
        if (allResults == null || !allResults.Any())
        {
            // No cached results yet, do nothing
            return;
        }
    
        if (maxDistance >= 999999)
        {
            // "All" selected - show everything
            results = allResults;
        }
        else
        {
            // Filter by distance
            results = allResults
                .Where(p => p.UserPractitionerProximityMiles <= maxDistance)
                .ToList();
        }
    
        StateHasChanged();
    }

    private async Task OnDistanceChanged()
    {
        if (!hasSearched) return; // Haven't searched yet
    
        // Re-run the last search with new distance
        if (!string.IsNullOrEmpty(lastZipCode))
        {
            await SearchByZip();
        }
        else if (!string.IsNullOrEmpty(lastAddress))
        {
            await SearchByAddress();
        }
        // Add lastLat/lastLon tracking if you want to support location re-search
    }
}